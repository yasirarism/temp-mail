<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Temp Mail</title>
  <style>
    body{font-family:ui-monospace,monospace;background:#0b0d12;color:#dfe;margin:0}
    .wrap{max-width:920px;margin:24px auto;padding:16px}
    .card{border:1px solid #334;background:#0f131b;border-radius:14px;padding:12px;margin:12px 0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{border:1px solid #334;background:#0f131b;color:#dfe;border-radius:10px;padding:8px}
    button{cursor:pointer}
    .mail{padding:10px;border:1px solid #223;border-radius:10px;background:#0c1118;margin:8px 0}
    .attachments a{color:#7bd;display:block;margin:2px 0}
    iframe{width:100%;height:320px;border:1px solid #334;border-radius:8px;background:#fff}
    .muted{color:#9ab}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>&gt; TEMPMAIL.</h1>
    <div class="card">
      <div class="controls">
        <label>USER:</label>
        <input id="prefix" placeholder="enter_prefix" />
        <label>DOMAIN:</label>
        <select id="domain"></select>
        <button id="btnSet">ACCESS INBOX &gt;</button>
        <button id="btnRnd" title="Generate random">↻</button>
        <button id="btnCopy">Copy</button>
      </div>
      <div class="muted" style="margin-top:8px">Current: <span id="curr">-</span></div>
    </div>

    <div class="card">
      <h3>Inbox</h3>
      <div id="list" class="muted">Empty…</div>
    </div>
  </div>

<script>
let currentEmail = null;

async function loadDomains(){
  const r = await fetch('/api/domains');
  const j = await r.json();
  const sel = document.getElementById('domain');
  sel.innerHTML = '';
  j.domains.forEach(d=>{
    const o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o);
  });
}

async function setEmail(addr){
  currentEmail = addr;
  document.getElementById('curr').textContent = addr;
  await loadInbox();
}

async function randomEmail(){
  const r = await fetch('/api/new'); const j = await r.json();
  const domain = document.getElementById('domain').value || j.email.split('@')[1];
  const pref = j.email.split('@')[0];
  await setEmail(`${pref}@${domain}`);
}

async function accessInbox(){
  const pref = document.getElementById('prefix').value.trim();
  const dom = document.getElementById('domain').value;
  if(!pref){ alert('prefix kosong'); return; }
  const fd = new FormData(); fd.append('address', `${pref}@${dom}`);
  const r = await fetch('/api/custom', {method:'POST', body:fd});
  const j = await r.json();
  await setEmail(j.email);
  history.replaceState(null,'', '/'+encodeURIComponent(j.email));
}

async function loadInbox(){
  if(!currentEmail) return;
  const r = await fetch('/api/inbox/'+encodeURIComponent(currentEmail));
  const j = await r.json();
  const list = document.getElementById('list');
  if(!j.length){ list.innerHTML = '<i>No emails yet…</i>'; return; }
  list.innerHTML = j.map(m=>`
    <div class="mail">
      <div><b>${m.subject || '(no subject)'}</b></div>
      <div class="muted">From: ${m.from} — ${new Date(m.date).toLocaleString()}</div>
      ${m.body_html ? `<iframe sandbox="allow-same-origin" srcdoc="${m.body_html.replace(/"/g,'&quot;')}"></iframe>` : ''}
      ${m.body_text && !m.body_html ? `<pre style="white-space:pre-wrap">${m.body_text.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</pre>` : ''}
      ${m.attachments && m.attachments.length ? `<div class="attachments"><b>Attachments:</b>${m.attachments.map(a=>`<a href="${a.url}" target="_blank" rel="noopener">${a.filename}</a>`).join('')}</div>`:''}
    </div>
  `).join('');
}

document.getElementById('btnRnd').onclick = randomEmail;
document.getElementById('btnSet').onclick = accessInbox;
document.getElementById('btnCopy').onclick = ()=>{
  if(currentEmail){ navigator.clipboard.writeText(currentEmail); alert('Copied '+currentEmail); }
};

(async function init(){
  await loadDomains();
  // if opened as /user@domain
  const path = decodeURIComponent(location.pathname.slice(1));
  if(path.includes('@')){
    document.getElementById('prefix').value = path.split('@')[0];
    const sel = document.getElementById('domain');
    const d = path.split('@')[1];
    [...sel.options].forEach(o=>{ if(o.value===d) sel.value=d; });
    await setEmail(path);
  }else{
    await randomEmail();
  }
  setInterval(loadInbox, 10000);
})();
</script>
</body>
</html>